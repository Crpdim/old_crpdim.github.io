---
title: 数据链路层
tags: 计算机网络
mathjax: true
mode: immersive
comment: true
pageview: true
key: A0011
header:
  theme: dark
article_header:
  type: cover
  image:
    src: /escape.jpg


---


* content
{:toc}


# 数据链路层

## 功能

1. 为网络层提供服务
   * 无确认无连接
   * 有确认无连接
   * 有确认面向连接
2. 链路管理
3. 组帧
4. 流量控制
5. 差错控制

## 组帧

原因：为使接收方正确接收并检查所传输的帧，发送方依据一定规则将网络层递交的分组封装成帧，组帧解决帧定界、帧同步、透明传输等问题

### 组帧实现方法

1. 字符计数法
2. 字符填充的首尾定界符法
3. 零比特填充法
4. 违规编码法

## 差错控制

通信链路中可能会产生比特差错，通常利用编码技术进行差错控制，分为两类：自动重传请求ARQ、前向纠错FEC。控制分为检测编码和纠错编码。

### 检错编码

* 奇偶校验码

  n-1位信息元和1位校验元，奇校验码，添加一位校验码0或1，使n位码字中1的数量为奇数

* 循环冗余码CRC

### 纠错编码

* 海明码

## 流量控制与可靠传输机制

流量控制涉及对链路帧的发送速率的控制，使接收方有足够的缓存空间接收每个帧。基本方法是由接收方控制发送发发送数据速率，常见方式有：停止-等待协议，滑动窗口协议。

#### 停止-等待协议流量控制原理

发送方发完一帧，需要等待接收方的应答信号才能发送下一帧，收不到应答信号则等待，效率很低。

#### 滑动窗口流量控制原理

发送方维持一组允许发送的帧的序号，称为发送窗口，接收方维持一组连续的允许接收帧的序号，称为接收窗口，发送窗口用来对发送方进行流量控制。

#### 可靠传输机制

数据链路层可靠传输通常使用确认和超时重传两种机制完成。确认机制让发送方知道哪些内容被正确接收，超时重传机制在收不到来自接收方的确认消息时，等待一段时间重新发送数据帧。

### 单帧滑动窗口与停止-等待协议

发送端发送单个帧必须等待接收方的确认，才能发送下一帧。 信道利用率很低

#### 帧受到损坏：

接收方直接丢弃，发送方等待超时并重传。

#### 帧正确但未收到确认：

发送方超时重传 ，接收方收到重复的帧后丢弃，并重传确认帧（未防止接收同一个帧，发送方在发送时会设置1bit的标志位，标识当前帧编号（0、1交替编号））

### 多帧滑动窗口与回退N帧协议GBN

发送方连续发送帧，接收方按序接收。当接收方检测到失序时，要求发送方发送最后一个正确帧之后所有帧；或发送方发送N帧后，发现该N帧前一个帧超时后未收到确认信息，发送方必须重发该帧和它之后的N个帧。

采用n比特对帧进行编号，发送窗口大小应满足(1≤ W<sub>t</sub> ≤ 2<sup>n</sup>-1) 若窗口大于 2<sup>n</sup>-1,接收方可能无法分辨新旧帧.

### 多帧滑动窗口与选择重传协议SR

接收方记录它没有收到的最早的帧的序列号，并发送确认帧时使用这个序列号。如果一个发送的帧没有到达接收方，发送方继续发送后面的帧，直到它填满发送窗口 。接收方持续用接收的帧填充它的接收窗口，并且每次回复一个带有序列号的确认帧。一旦发送窗口所有帧都发送了 ，发送方重新发送的帧号与ACK对应的帧，然后继续。 

用n比特对帧进行编号，W<sub>T</sub> 未发送方窗口大小， W<sub>R</sub> 为接收方窗口大小，需要满足W<sub>Tmax</sub> = W<sub>Rmax</sub> = 2<sup>n-1</sup> 即窗口大小不能超过序号范围一半。

## 介质访问控制

介质访问控制为适用介质的每个节点隔离来自同一信道的其他节点所传送的信号，以协调活动节点的传输。

### 信道划分介质访问控制

将使用介质的每个设备与来自同一通信信道的其他设备的通信隔离开，将时域与频域资源合理的分配给网络上的设备。

#### 多路复用技术

将多个输入通道的信息整合到一个复用信道，在接收端把收到的信息分离出来并传到对应的输出通道。

#### 频分多路复用FDM

将多路基带信号调制到不同频率载波上，并叠加形成一个复合信号的多路复用技术

优点： 充分利用传输介质的带宽，系统效率高，技术成熟实现容易。

#### 时分多路复用TDM

将一条物理信道划分多个时间片，轮流分配给多个信号使用，同一用户只能在不同周期的相同阶段发送信号。

##### STDM异步时分多路复用

TDM的改进，动态分配时隙，终端有数据需要传送时才分配时间片，提高了线路的利用率。

#### 波分多路复用BDM

光的频分复用，在一根光线中传输多个不同波长的光信号，因为光波长不同，各路光信号互不干扰，最后由波长分解复用器将各路波长分解出来。

#### 码分多路复用CDM

各用户使用经过特殊挑选的不同码型，可以在相同时间使用相同频带进行通信。

使用CDM的每个站被指派一个唯一的mbit码片序列。若发送1，则发送自己的mbit码片序列；若发送0，则发送自己的mbit码片序列反码

##### 码片挑选原则

1. 每个站码片序列必须各不相同

2. 分配给每个站的码片序列必须相互正交（规格化内积为0）

   两不同站码片序列用向量S和T表示，S和T的规格化内积为 S与T对应分量相乘的结果进行累加，最后除以分量数量。

## 随机访问介质访问控制

不采用集中控制方式解决发送信息的次序问题，所有用户能根据自己的医院随机的发送信息，占用信道全部速率。总线型网络当两个或多个用户同时发送信息时，会产生帧冲突，为解决随机接入产生的碰撞，引入一些随机访问介质访问控制协议。

### ALOHA协议

不进行任何检测,直接发送数据,遇到冲突,等待随机一段时间,再次发送数据.发生冲突的可能性很高,所以纯ALOHA协议网络吞吐量很低.

### 时隙ALOHA协议

规定用户只能在每个时隙开始才能发送一个帧,避免了用户发送数据的随机性,减少冲突可能性,提高了信道利用率.

### CSMA协议(Carrier Sense Multiple Access)载波监听多路访问

#### 思想

站点在发送前侦听共用信道，信道空闲时再发送，大大降低了冲突的可能性。

#### 1-坚持CSMA

侦听到信道忙，**坚持侦听**，直到信道空闲，立刻发送数据。

传播时延对1坚持CSMA性能影响较大，A在信道中发送数据同时，B也在要发送数据，由于传播时延，A发送的数据还未到B，B侦测到信道空闲，就立刻发送数据，导致冲突。

当AB同时准备向C发送数据时，检测到信道忙，AB都持续侦听信道，当信道空闲时间，同时发送数据，必然导致冲突。

#### 非坚持CSMA

侦听到信道空闲，立刻发送数据，若侦听到信道忙，不坚持侦听信道，等待**随机一段时间**，重复这个过程。

在侦听到信道忙，放弃侦听，降低了多个节点等待信道空闲同时发送数据导致冲突的概率，不过增加了网络平均延迟。

#### p-坚持CSMA

信道忙，则持续监听，直到信道空闲，如果侦听到信道空闲，以概率p发送数据，以概率1-p推迟到下一个时隙，**在下一时隙**重复这个过程。直到数据发送成功或侦听到信道被其他节点占用。若信道被其他节点占用，在下一时隙重新侦听。

### CSMA/CD (CD:Collision Detection碰撞检测)

> 适用于半双工以太网

持续侦听信道，信道空闲，则发送信息，并同时进行碰撞检测。若检测到发生碰撞，停止发送，等待随机一段时间重新发送。

为确保发送数据的同时能检测到可能存在的碰撞，需要在发送完帧之前就能收到自己发送的数据，帧的传输时延必须两倍于数据在总线中的传播时延。即： 帧长÷数据传输速率 ≥ 2 x 传播时延

最小帧长 =  2 x 传播时延 x 数据传输速率

CSMA/CD除可以检测冲突，还可以从冲突中恢复。发生冲突，CSMA/CD采用二进制指数退避算法解决碰撞问题。

#### 二进制指数退避算法流程

1. 确定退避时间，一般取两倍于总线的传播时延2τ
2. 定义参数k，重传次数不超过10时，k为当前重传次数，超过10时，k不再增大，一直为10.
3. 从离散整数集合(0~2<sup>k</sup>-1)中随机取一个整数r，重传所需退避时间为2τ•r
4. 重传超过16次，说明网络拥挤，抛弃此帧并向高层报错。

### CSMA/CA (CA:Collision Avoidance碰撞避免)

> 适用于无线通信，在无线通信时不能直接使用CSMA/CD协议，因为无线网络存在隐蔽站问题且信号强度变化很大，坚持碰撞硬件上实现复杂。

#### IFS：帧间间隔

所有站完成数据发送后，必须等待很短的一段时间才能发送下一帧，这段时间称为IFS，IFS长短取决于发送帧的类型。

#### 802.11 三种IFS

* SIF（短IFS）：最短IFS，分隔属于一次对话的各帧，如ACK帧，CTS帧分片后的数据帧，以及回答AP探寻的帧
* PIFS（点协调IFS）：中等长度IFS，在PCF操作中使用
* DIFS*分布式协调IFS）：最长IFS， 用于异步帧竞争访问时延

#### CSMA/CA算法：

1. 站点最初有数据要发送，且检测到信道空闲，等待DIFS后发送整个数据帧

2. 否则执行退避算法，选取一个随机回退值。检测到信道忙，退避计时器就保持不变，直到信道空闲，退避计时器开始计时

3. 退避计时器到0时，站点发送整个帧并等待确认

4. 发送站收到确认，若要发送另一个帧，则从步骤2开始

   若未收到确认帧，则重传该帧，直到收到确认，或若干次重传失败后放弃发送

#### 隐蔽站问题：

隐蔽站：假设A、B为两相隔较远站，互相检测不到对方，AP位于A和B之间，A和B都在AP的覆盖范围，A、B侦听信道空闲时同时向AP发送数据，就会引起冲突。

##### 解决步骤：

1. 源站发送数据帧时广播一个请求发送RTS的控制帧，包括原地址，目的地之和此次通信时间，能被其范围内的所有站点听到
2. 目的地址收到请求发送请求，若信道空闲，则广播一个允许发送CTS控制帧，包括通信的持续时间，能被它范围内的所有站点听到
3. 其他想与它发送的站点会在CTS中的时间内抑制发送。

## 轮询访问

>  用户不能随机发送消息，而需要通过集中控制监控站，以循环方式轮询每个节点，所以网络逻辑上必须为环形网络。

### 令牌传递协议

一个令牌沿着环形总线在节点间轮流传递，令牌是一个特殊mac控制帧，本身不包含信息，仅有控制信道作用，确保同一时刻信道只有一个站点独占。

#### 过程：

1. 当一个站点希望传送帧时，等待令牌传到自己，修改令牌中的标志位，并附加发送的数据，将其沿着环路传播。
2. 接收端收到带有数据的令牌后，复制一份数据，将令牌继续往下传。
3. 当令牌回到发送端后，检查数据是否出错，若没有出错，重新生成一个新令牌，继续轮询传递。否则重传
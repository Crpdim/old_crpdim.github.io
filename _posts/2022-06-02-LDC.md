# 受限直接执行机制

## CPU的虚拟化

OS需要某种方式让多任务共享物理CPU,让他们看起来是同时运行的

### 虚拟化基本思想

运行一个进程一段时间,然后运行另一个进程,这样轮换执行,通过这种时分共享机制,就可以实现CPU的虚拟化

## 受限的直接执行技术

### 直接执行

直接在CPU上运行程序即可,当OS希望启动程序运行时,它会在进程列表中为其创建一个进程条目,并为其分配内存,将程序加载到内存中,找到程序的入口程序(如c语言 main函数),并跳转到那里,开始执行用户代码

### 直接执行问题一: OS如何确保程序不做我们不希望它做的事(受限制的操作)

直接执行的方法优点是快,但是,在CPU上运行时,OS无法干涉,如果进程希望执行某种受限制的操作,例如向磁盘发送IO请求或者其他资源,直接执行的话可能影响系统的稳定.

#### 解决办法: 引入用户模式和内核模式

用户模式:进程在用户模式下代码会受到限制,无法进行受限制的操作,例如用户态无法发出IO请求,这样做直接会导致处理器引发异常,OS可能会终止进程

内核模式: OS直接运行在内核模式,此模式运行的代码将不受限制.

##### 如果用户希想要执行某特权指令呢? --系统调用

系统调用允许OS向用户进程暴露某些关键功能,如访问文件系统,创建和销毁进程或者与其他进程通信以及申请内存.

若要执行系统调用,应用程序需要执行陷入(trap)指令,该指令同时跳入内核并将特权指令级别提升到内核模式,进入内核后,便能执行任何受限操作,从而为调用进程执行所需要的工作.完成后,OS调用一个特殊的陷阱返回指令,该指令返回到发起调用的应用程序,并将特权级别降低到用户模式.(执行陷入指令时,硬件必须确保存储足够的调用者寄存器,以便能正确返回应用程序)

##### 陷入指令怎么知道OS内执行哪些代码?

发起调用的过程不能指定跳转地址(这样会让程序可以访问到内核的任何地方),内核为谨慎的控制陷阱上执行的代码,在启动时会设置陷阱表,OS在启动时,在内核态运行,可以自由配置机器硬件,OS做的第一件事就是告诉硬件在某些异常事件是运行哪些代码.

### 